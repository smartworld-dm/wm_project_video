(function(e,a){"function"===typeof define&&define.amd?define([],a):"object"===typeof exports?module.exports=a():e.YUVCanvas=a()})(this,function(){function e(a){a=a||{};this.canvasElement=a.canvas||document.createElement("canvas");this.contextOptions=a.contextOptions;this.type=a.type||"yuv420";this.customYUV444=a.customYUV444;this.width=a.width||640;this.height=a.height||320;this.animationTime=a.animationTime||0;this.canvasElement.width=this.width;this.canvasElement.height=this.height;this.initContextGL();
this.contextGL&&(this.initProgram(),this.initBuffers(),this.initTextures());"yuv420"===this.type?this.drawNextOuptutPictureGL=function(a){var b=this.contextGL,c=this.texturePosBuffer,g=this.uTexturePosBuffer,e=this.vTexturePosBuffer,d=this.yTextureRef,n=this.uTextureRef,q=this.vTextureRef,p=a.yData,v=a.uData,y=a.vData,l=this.width,m=this.height,w=a.yDataPerRow||l,x=a.yRowCnt||m,r=a.uDataPerRow||l/2,t=a.uRowCnt||m/2,u=a.vDataPerRow||r;a=a.vRowCnt||t;b.viewport(0,0,l,m);var h=m/x,k=l/w;h=new Float32Array([k,
0,0,0,k,h,0,h]);b.bindBuffer(b.ARRAY_BUFFER,c);b.bufferData(b.ARRAY_BUFFER,h,b.DYNAMIC_DRAW);this.customYUV444?(h=m/t,k=l/r):(h=m/2/t,k=l/2/r);c=new Float32Array([k,0,0,0,k,h,0,h]);b.bindBuffer(b.ARRAY_BUFFER,g);b.bufferData(b.ARRAY_BUFFER,c,b.DYNAMIC_DRAW);this.customYUV444?(h=m/a,k=l/u):(h=m/2/a,k=l/2/u);g=new Float32Array([k,0,0,0,k,h,0,h]);b.bindBuffer(b.ARRAY_BUFFER,e);b.bufferData(b.ARRAY_BUFFER,g,b.DYNAMIC_DRAW);b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,d);b.texImage2D(b.TEXTURE_2D,
0,b.LUMINANCE,w,x,0,b.LUMINANCE,b.UNSIGNED_BYTE,p);b.activeTexture(b.TEXTURE1);b.bindTexture(b.TEXTURE_2D,n);b.texImage2D(b.TEXTURE_2D,0,b.LUMINANCE,r,t,0,b.LUMINANCE,b.UNSIGNED_BYTE,v);b.activeTexture(b.TEXTURE2);b.bindTexture(b.TEXTURE_2D,q);b.texImage2D(b.TEXTURE_2D,0,b.LUMINANCE,u,a,0,b.LUMINANCE,b.UNSIGNED_BYTE,y);b.drawArrays(b.TRIANGLE_STRIP,0,4)}:"yuv422"===this.type&&(this.drawNextOuptutPictureGL=function(a){var b=this.contextGL,c=this.texturePosBuffer,g=this.textureRef,e=a.data,d=this.width,
n=this.height,q=a.dataPerRow||2*d;a=a.rowCnt||n;b.viewport(0,0,d,n);var p=n/a;d/=q/2;d=new Float32Array([d,0,0,0,d,p,0,p]);b.bindBuffer(b.ARRAY_BUFFER,c);b.bufferData(b.ARRAY_BUFFER,d,b.DYNAMIC_DRAW);b.uniform2f(b.getUniformLocation(this.shaderProgram,"resolution"),q,n);b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,g);b.texImage2D(b.TEXTURE_2D,0,b.LUMINANCE,q,a,0,b.LUMINANCE,b.UNSIGNED_BYTE,e);b.drawArrays(b.TRIANGLE_STRIP,0,4)})}e.prototype.isWebGL=function(){return this.contextGL};e.prototype.initContextGL=
function(){for(var a=this.canvasElement,c=null,b=["webgl","experimental-webgl","moz-webgl","webkit-3d"],f=0;!c&&f<b.length;){var g=b[f];try{c=this.contextOptions?a.getContext(g,this.contextOptions):a.getContext(g)}catch(z){c=null}c&&"function"===typeof c.getParameter||(c=null);++f}this.contextGL=c};e.prototype.initProgram=function(){var a=this.contextGL;if("yuv420"===this.type){var c="attribute vec4 vertexPos;\nattribute vec4 texturePos;\nattribute vec4 uTexturePos;\nattribute vec4 vTexturePos;\nvarying vec2 textureCoord;\nvarying vec2 uTextureCoord;\nvarying vec2 vTextureCoord;\nvoid main()\n{\n  gl_Position = vertexPos;\n  textureCoord = texturePos.xy;\n  uTextureCoord = uTexturePos.xy;\n  vTextureCoord = vTexturePos.xy;\n}";
var b="precision highp float;\nvarying highp vec2 textureCoord;\nvarying highp vec2 uTextureCoord;\nvarying highp vec2 vTextureCoord;\nuniform sampler2D ySampler;\nuniform sampler2D uSampler;\nuniform sampler2D vSampler;\nconst mat4 YUV2RGB = mat4\n(\n  1.1643828125, 0, 1.59602734375, -.87078515625,\n  1.1643828125, -.39176171875, -.81296875, .52959375,\n  1.1643828125, 2.017234375, 0, -1.081390625,\n  0, 0, 0, 1\n);\nvoid main(void) {\n  highp float y = texture2D(ySampler,  textureCoord).r;\n  highp float u = texture2D(uSampler,  uTextureCoord).r;\n  highp float v = texture2D(vSampler,  vTextureCoord).r;\n  gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;\n}"}else"yuv422"===
this.type&&(c="attribute vec4 vertexPos;\nattribute vec4 texturePos;\nvarying vec2 textureCoord;\nvoid main()\n{\n  gl_Position = vertexPos;\n  textureCoord = texturePos.xy;\n}",b="precision highp float;\nvarying highp vec2 textureCoord;\nuniform sampler2D sampler;\nuniform highp vec2 resolution;\nconst mat4 YUV2RGB = mat4\n(\n  1.1643828125, 0, 1.59602734375, -.87078515625,\n  1.1643828125, -.39176171875, -.81296875, .52959375,\n  1.1643828125, 2.017234375, 0, -1.081390625,\n  0, 0, 0, 1\n);\nvoid main(void) {\n  highp float texPixX = 1.0 / resolution.x;\n  highp float logPixX = 2.0 / resolution.x;\n  highp float logHalfPixX = 4.0 / resolution.x;\n  highp float steps = floor(textureCoord.x / logPixX);\n  highp float uvSteps = floor(textureCoord.x / logHalfPixX);\n  highp float y = texture2D(sampler, vec2((logPixX * steps) + texPixX, textureCoord.y)).r;\n  highp float u = texture2D(sampler, vec2((logHalfPixX * uvSteps), textureCoord.y)).r;\n  highp float v = texture2D(sampler, vec2((logHalfPixX * uvSteps) + texPixX + texPixX, textureCoord.y)).r;\n  gl_FragColor = vec4(y, u, v, 1.0) * YUV2RGB;\n}");
var f=a.createShader(a.VERTEX_SHADER);a.shaderSource(f,c);a.compileShader(f);a.getShaderParameter(f,a.COMPILE_STATUS)||console.log("Vertex shader failed to compile: "+a.getShaderInfoLog(f));c=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(c,b);a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||console.log("Fragment shader failed to compile: "+a.getShaderInfoLog(c));b=a.createProgram();a.attachShader(b,f);a.attachShader(b,c);a.linkProgram(b);a.getProgramParameter(b,a.LINK_STATUS)||console.log("Program failed to compile: "+
a.getProgramInfoLog(b));a.useProgram(b);this.shaderProgram=b};e.prototype.initBuffers=function(){var a=this.contextGL,c=this.shaderProgram,b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),a.STATIC_DRAW);b=a.getAttribLocation(c,"vertexPos");a.enableVertexAttribArray(b);a.vertexAttribPointer(b,2,a.FLOAT,!1,0,0);if(this.animationTime){var f=this.animationTime,g=0,e=function(){g+=15;var b=1*g/f;g>=f?b=1:setTimeout(e,15);var d=-1*b;b*=
1;var p=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,p);a.bufferData(a.ARRAY_BUFFER,new Float32Array([b,b,d,b,b,d,d,d]),a.STATIC_DRAW);d=a.getAttribLocation(c,"vertexPos");a.enableVertexAttribArray(d);a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0);try{a.drawArrays(a.TRIANGLE_STRIP,0,4)}catch(v){}};e()}b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),a.STATIC_DRAW);var d=a.getAttribLocation(c,"texturePos");a.enableVertexAttribArray(d);a.vertexAttribPointer(d,
2,a.FLOAT,!1,0,0);this.texturePosBuffer=b;"yuv420"===this.type&&(b=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),a.STATIC_DRAW),d=a.getAttribLocation(c,"uTexturePos"),a.enableVertexAttribArray(d),a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0),this.uTexturePosBuffer=b,b=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),a.STATIC_DRAW),d=a.getAttribLocation(c,"vTexturePos"),a.enableVertexAttribArray(d),
a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0),this.vTexturePosBuffer=b)};e.prototype.initTextures=function(){var a=this.contextGL,c=this.shaderProgram;if("yuv420"===this.type){var b=this.initTexture(),f=a.getUniformLocation(c,"ySampler");a.uniform1i(f,0);this.yTextureRef=b;b=this.initTexture();f=a.getUniformLocation(c,"uSampler");a.uniform1i(f,1);this.uTextureRef=b;b=this.initTexture();c=a.getUniformLocation(c,"vSampler");a.uniform1i(c,2);this.vTextureRef=b}else"yuv422"===this.type&&(b=this.initTexture(),
c=a.getUniformLocation(c,"sampler"),a.uniform1i(c,0),this.textureRef=b)};e.prototype.initTexture=function(){var a=this.contextGL,c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);return c};e.prototype.drawNextOutputPicture=
function(a,c,b,f){this.contextGL?this.drawNextOuptutPictureGL(a,c,b,f):this.drawNextOuptutPictureRGBA(a,c,b,f)};e.prototype.drawNextOuptutPictureRGBA=function(a,c,b,f){var e=this.canvasElement;b=null;e=e.getContext("2d");a=e.getImageData(0,0,a,c);a.data.set(f);null===b?e.putImageData(a,0,0):e.putImageData(a,-b.left,-b.top,0,0,b.width,b.height)};return e});